<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Workout Tracker</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#1a1a2e" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèã</text></svg>" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Inter:wght@400;500;600&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-dark: #1a1a2e;
      --bg-navy: #16213e;
      --accent: #e94560;
      --accent-dim: #b8344d;
      --accent-glow: rgba(233, 69, 96, 0.25);
      --secondary: #4a90b8;
      --secondary-dim: #3a7295;
      --text: #e8e8e8;
      --text-dim: #8890a0;
      --text-muted: #555e70;
      --card-bg: rgba(255, 255, 255, 0.06);
      --card-border: rgba(255, 255, 255, 0.1);
      --input-bg: rgba(0, 0, 0, 0.3);
      --input-border: rgba(255, 255, 255, 0.15);
      --success: #4caf50;
      --warning: #ff9800;
      --font-display: 'Oswald', Impact, 'Arial Black', sans-serif;
      --font-body: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    html {
      height: 100%;
      background: var(--bg-navy);
    }

    body {
      min-height: 100%;
      background: linear-gradient(170deg, var(--bg-dark) 0%, var(--bg-navy) 100%) fixed;
      color: var(--text);
      font-family: var(--font-body);
      font-size: 16px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
    }

    body {
      display: flex;
      justify-content: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      min-height: 100%;
      min-height: 100dvh;
    }

    .app {
      width: 100%;
      max-width: 480px;
      padding: 1rem;
      padding-top: 0.75rem;
    }

    /* Back link */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      color: var(--text-dim);
      text-decoration: none;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      transition: color 0.15s;
    }
    .back-link:hover { color: var(--text); }
    .back-link svg { width: 14px; height: 14px; }

    /* View management */
    .view { display: none; }
    .view.active { display: block; }

    /* Page titles */
    .page-title {
      font-family: var(--font-display);
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--text);
      text-shadow: 0 0 20px var(--accent-glow);
      margin-bottom: 0.25rem;
    }

    .page-subtitle {
      color: var(--text-dim);
      font-size: 0.85rem;
      margin-bottom: 1.25rem;
    }

    /* Workout grid */
    .workout-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.65rem;
      padding-bottom: 2rem;
    }

    .workout-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .workout-card:hover { border-color: var(--accent); background: rgba(233, 69, 96, 0.06); }
    .workout-card:active { background: rgba(233, 69, 96, 0.12); }

    .workout-card .wc-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    .wc-icon.strength { background: rgba(233, 69, 96, 0.18); color: var(--accent); }
    .wc-icon.cardio { background: rgba(74, 144, 184, 0.18); color: var(--secondary); }
    .wc-icon.flexibility { background: rgba(76, 175, 80, 0.18); color: var(--success); }
    .wc-icon.core { background: rgba(255, 152, 0, 0.18); color: var(--warning); }

    .workout-card .wc-info { flex: 1; min-width: 0; }
    .workout-card .wc-name {
      font-family: var(--font-display);
      font-size: 1.05rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .workout-card .wc-meta {
      font-size: 0.75rem;
      color: var(--text-dim);
      display: flex;
      gap: 0.75rem;
    }
    .workout-card .wc-arrow {
      color: var(--text-muted);
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    /* Resume banner */
    .resume-banner {
      background: rgba(233, 69, 96, 0.12);
      border: 1px solid rgba(233, 69, 96, 0.3);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: background 0.15s;
    }
    .resume-banner:hover { background: rgba(233, 69, 96, 0.18); }
    .resume-banner .rb-info { flex: 1; }
    .resume-banner .rb-title { font-weight: 600; font-size: 0.9rem; color: var(--accent); }
    .resume-banner .rb-detail { font-size: 0.75rem; color: var(--text-dim); }
    .resume-banner .rb-actions { display: flex; gap: 0.5rem; }
    .resume-banner .rb-btn {
      padding: 0.35rem 0.75rem;
      border-radius: 6px;
      border: none;
      font-size: 0.8rem;
      font-family: var(--font-body);
      cursor: pointer;
      font-weight: 500;
    }
    .rb-btn.resume { background: var(--accent); color: #fff; }
    .rb-btn.discard { background: rgba(255,255,255,0.08); color: var(--text-dim); }

    /* Session view header */
    .session-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .session-header .sh-back {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.4rem;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }
    .session-header .sh-title {
      flex: 1;
      font-family: var(--font-display);
      font-size: 1.2rem;
      font-weight: 600;
      text-transform: uppercase;
      text-align: center;
    }
    .session-header .sh-finish {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      font-family: var(--font-body);
      font-weight: 600;
      cursor: pointer;
    }

    /* Progress bar */
    .progress-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .progress-bar {
      flex: 1;
      height: 4px;
      background: rgba(255,255,255,0.08);
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    .progress-text {
      font-size: 0.75rem;
      color: var(--text-dim);
      white-space: nowrap;
    }

    /* Prev/next exercise preview */
    .exercise-preview {
      font-size: 0.78rem;
      color: var(--text-muted);
      padding: 0.3rem 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .exercise-preview:hover { color: var(--text-dim); }
    .exercise-preview .ep-label { color: var(--text-muted); font-weight: 500; min-width: 3rem; }
    .exercise-preview .ep-name { color: var(--text-dim); }

    /* Exercise card */
    .exercise-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 1rem;
      margin: 0.5rem 0;
    }

    .ec-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    .ec-number {
      font-size: 0.75rem;
      color: var(--accent);
      font-weight: 600;
      font-family: var(--font-display);
    }
    .ec-name {
      font-family: var(--font-display);
      font-size: 1.3rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      line-height: 1.2;
    }
    .ec-timer {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--secondary);
      min-width: 4rem;
      text-align: right;
      letter-spacing: 0.05em;
    }
    .ec-timer.expired { color: var(--accent); animation: timer-flash 0.8s ease-in-out infinite; }
    @keyframes timer-flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Description */
    .ec-desc-wrap { margin-bottom: 0.75rem; }
    .ec-desc {
      font-size: 0.85rem;
      color: var(--text-dim);
      line-height: 1.4;
    }
    .ec-desc-edit {
      background: none;
      border: none;
      color: var(--secondary);
      font-size: 0.75rem;
      cursor: pointer;
      padding: 0.15rem 0;
    }
    .ec-desc-textarea {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      color: var(--text);
      font-family: var(--font-body);
      font-size: 0.85rem;
      padding: 0.5rem;
      resize: vertical;
      min-height: 3rem;
      margin-top: 0.25rem;
    }

    /* Last time panel */
    .last-time {
      background: rgba(74, 144, 184, 0.08);
      border-left: 3px solid var(--secondary);
      border-radius: 0 6px 6px 0;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.75rem;
      font-size: 0.82rem;
    }
    .last-time .lt-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.15rem;
    }
    .last-time .lt-value { color: var(--secondary); font-weight: 500; }
    .lt-no-data { color: var(--text-muted); font-style: italic; }

    /* History toggle */
    .history-toggle {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 0.75rem;
      cursor: pointer;
      padding: 0.25rem 0;
      font-family: var(--font-body);
    }
    .history-toggle:hover { color: var(--text-dim); }

    .history-list {
      display: none;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 0.35rem;
    }
    .history-list.open { display: block; }
    .history-item {
      font-size: 0.78rem;
      color: var(--text-dim);
      padding: 0.2rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .history-item .hi-date { color: var(--text-muted); }

    /* Input section */
    .input-section { margin-top: 0.5rem; }
    .input-section .is-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .input-group label {
      font-size: 0.8rem;
      color: var(--text-dim);
      min-width: fit-content;
    }
    .input-group input[type="number"] {
      width: 4.5rem;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      color: var(--text);
      font-family: var(--font-body);
      font-size: 1.25rem;
      font-weight: 600;
      padding: 0.45rem 0.5rem;
      text-align: center;
      -moz-appearance: textfield;
      appearance: textfield;
    }
    .input-group input[type="number"]::-webkit-inner-spin-button,
    .input-group input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
    }
    .input-group input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin-top: 0.25rem;
    }
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }
    .checkbox-group label {
      font-size: 0.8rem;
      color: var(--text-dim);
    }

    .input-group .unit {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* Nav buttons */
    .step-nav {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      padding-bottom: 2rem;
    }
    .step-btn {
      flex: 1;
      padding: 0.85rem 1rem;
      border: none;
      border-radius: 10px;
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: background 0.15s, opacity 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .step-btn.prev {
      background: rgba(255,255,255,0.08);
      color: var(--text-dim);
    }
    .step-btn.prev:hover { background: rgba(255,255,255,0.12); }
    .step-btn.next {
      background: var(--accent);
      color: #fff;
    }
    .step-btn.next:hover { background: var(--accent-dim); }
    .step-btn:disabled { opacity: 0.3; cursor: default; }

    /* Exercise list overlay */
    .exercise-list-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 50;
      justify-content: center;
      align-items: flex-end;
    }
    .exercise-list-overlay.open { display: flex; }
    .exercise-list-panel {
      background: var(--bg-dark);
      border-top: 2px solid var(--accent);
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-width: 480px;
      max-height: 70vh;
      overflow-y: auto;
      padding: 1rem;
    }
    .exercise-list-panel .elp-title {
      font-family: var(--font-display);
      font-size: 1rem;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .exercise-list-panel .elp-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }
    .el-item {
      padding: 0.5rem 0.5rem;
      border-radius: 6px;
      font-size: 0.85rem;
      color: var(--text-dim);
      display: flex;
      gap: 0.5rem;
      cursor: pointer;
    }
    .el-item:hover { background: rgba(255,255,255,0.04); }
    .el-item.current { background: rgba(233, 69, 96, 0.15); color: var(--text); font-weight: 600; }
    .el-item.done { color: var(--text-muted); }
    .el-item .el-num { min-width: 1.5rem; color: var(--text-muted); font-weight: 500; }
    .el-item.current .el-num { color: var(--accent); }

    /* Summary view */
    .summary-card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .summary-card .sc-name {
      font-family: var(--font-display);
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .summary-card .sc-values {
      font-size: 0.82rem;
      color: var(--text-dim);
      margin-top: 0.2rem;
    }
    .summary-duration {
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--accent);
      text-align: center;
      margin: 1rem 0;
    }

    /* Settings */
    .settings-group {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
    }
    .settings-group .sg-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      font-family: var(--font-body);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-dim); }
    .btn-secondary { background: rgba(255,255,255,0.08); color: var(--text-dim); }
    .btn-secondary:hover { background: rgba(255,255,255,0.12); }
    .btn-danger { background: rgba(233, 69, 96, 0.15); color: var(--accent); }
    .btn-danger:hover { background: rgba(233, 69, 96, 0.25); }
    .btn + .btn { margin-left: 0.5rem; }

    /* Confirm modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: var(--bg-dark);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 1.25rem;
      max-width: 340px;
      width: 90%;
    }
    .modal-box .mb-title {
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }
    .modal-box .mb-text {
      font-size: 0.85rem;
      color: var(--text-dim);
      margin-bottom: 1rem;
    }
    .modal-box .mb-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    /* Gear icon */
    .gear-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.25rem;
    }
    .gear-btn:hover { color: var(--text-dim); }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-dark);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      color: var(--text);
      z-index: 200;
      transition: transform 0.3s ease;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* Responsive */
    @media (max-width: 360px) {
      .app { padding: 0.75rem; }
      .ec-name { font-size: 1.1rem; }
      .ec-timer { font-size: 1.3rem; }
    }

    @media (prefers-reduced-motion: reduce) {
      .ec-timer.expired { animation: none; }
      .progress-fill { transition: none; }
    }
  </style>
</head>
<body>

<div class="app">
  <a class="back-link" href="../">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
    vibes
  </a>

  <!-- WORKOUT LIST VIEW -->
  <div id="workoutListView" class="view active">
    <div class="title-row">
      <div>
        <h1 class="page-title">Workouts</h1>
        <p class="page-subtitle">Select a workout to begin</p>
      </div>
      <button class="gear-btn" onclick="showView('settingsView')" aria-label="Settings">&#9881;</button>
    </div>
    <div id="resumeBanner" class="resume-banner" style="display:none">
      <div class="rb-info">
        <div class="rb-title" id="resumeTitle"></div>
        <div class="rb-detail" id="resumeDetail"></div>
      </div>
      <div class="rb-actions">
        <button class="rb-btn discard" onclick="discardSession()">Discard</button>
        <button class="rb-btn resume" onclick="resumeSession()">Resume</button>
      </div>
    </div>
    <div id="workoutGrid" class="workout-grid"></div>
  </div>

  <!-- SESSION VIEW -->
  <div id="sessionView" class="view">
    <div class="session-header">
      <button class="sh-back" onclick="confirmExit()" aria-label="Back">&larr;</button>
      <div class="sh-title" id="sessionTitle"></div>
      <button class="sh-finish" onclick="finishWorkout()">Finish</button>
    </div>
    <div class="progress-wrap">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-text" id="progressText"></div>
    </div>
    <div id="prevPreview" class="exercise-preview" onclick="openExerciseList()">
      <span class="ep-label">Prev:</span>
      <span class="ep-name" id="prevName"></span>
    </div>
    <div class="exercise-card" id="exerciseCard">
      <div class="ec-top">
        <div>
          <div class="ec-number" id="ecNumber"></div>
          <div class="ec-name" id="ecName"></div>
        </div>
        <div class="ec-timer" id="ecTimer" style="display:none"></div>
      </div>
      <div class="ec-desc-wrap">
        <div class="ec-desc" id="ecDesc"></div>
        <button class="ec-desc-edit" id="ecDescEditBtn" onclick="toggleDescEdit()">edit description</button>
        <textarea class="ec-desc-textarea" id="ecDescTextarea" style="display:none" rows="2"></textarea>
      </div>
      <div id="lastTimePanel" class="last-time" style="display:none">
        <div class="lt-label">Last time</div>
        <div class="lt-value" id="ltValue"></div>
        <button class="history-toggle" id="historyToggle" onclick="toggleHistory()">Show all history</button>
        <div class="history-list" id="historyList"></div>
      </div>
      <div class="input-section" id="inputSection"></div>
    </div>
    <div id="nextPreview" class="exercise-preview" onclick="openExerciseList()">
      <span class="ep-label">Next:</span>
      <span class="ep-name" id="nextName"></span>
    </div>
    <div class="step-nav">
      <button class="step-btn prev" id="btnPrev" onclick="stepPrev()">&#9664; Prev</button>
      <button class="step-btn next" id="btnNext" onclick="stepNext()">Next &#9654;</button>
    </div>
  </div>

  <!-- SUMMARY VIEW -->
  <div id="summaryView" class="view">
    <h1 class="page-title">Workout Complete</h1>
    <div class="summary-duration" id="summaryDuration"></div>
    <div id="summaryList"></div>
    <div class="step-nav">
      <button class="step-btn next" onclick="showView('workoutListView'); loadWorkoutList();" style="flex:none; width:100%">Back to Workouts</button>
    </div>
  </div>

  <!-- SETTINGS VIEW -->
  <div id="settingsView" class="view">
    <h1 class="page-title">Settings</h1>
    <p class="page-subtitle">Data management</p>
    <div class="settings-group">
      <div class="sg-title">Export Data</div>
      <p style="font-size:0.82rem;color:var(--text-dim);margin-bottom:0.5rem">Download all workout history as a JSON file.</p>
      <button class="btn btn-secondary" onclick="doExport()">Export</button>
    </div>
    <div class="settings-group">
      <div class="sg-title">Import Data</div>
      <p style="font-size:0.82rem;color:var(--text-dim);margin-bottom:0.5rem">Restore from a previously exported file. This merges with existing data.</p>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="doImport(event)" />
      <button class="btn btn-secondary" onclick="$('importFile').click()">Import</button>
    </div>
    <div class="settings-group">
      <div class="sg-title">Clear All Data</div>
      <p style="font-size:0.82rem;color:var(--text-dim);margin-bottom:0.5rem">Permanently delete all sessions and history.</p>
      <button class="btn btn-danger" onclick="confirmClear()">Clear Data</button>
    </div>
    <div class="step-nav">
      <button class="step-btn prev" onclick="showView('workoutListView')" style="flex:none; width:100%">&#9664; Back</button>
    </div>
  </div>
</div>

<!-- Exercise list overlay -->
<div class="exercise-list-overlay" id="exerciseListOverlay" onclick="closeExerciseList(event)">
  <div class="exercise-list-panel" id="exerciseListPanel">
    <div class="elp-title">
      <span>Exercises</span>
      <button class="elp-close" onclick="closeExerciseList()">&times;</button>
    </div>
    <div id="exerciseListContent"></div>
  </div>
</div>

<!-- Confirm modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal-box">
    <div class="mb-title" id="modalTitle"></div>
    <div class="mb-text" id="modalText"></div>
    <div class="mb-actions">
      <button class="btn btn-secondary" id="modalCancel" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="modalConfirm">Confirm</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="./workout-data.js"></script>
<script>
"use strict";

/* ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ */
const $ = (id) => document.getElementById(id);
function uuid() {
  return crypto.randomUUID ? crypto.randomUUID() : 'xxxx-xxxx-xxxx'.replace(/x/g, () => ((Math.random()*16)|0).toString(16));
}
function fmtDate(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
function fmtDuration(ms) {
  const m = Math.floor(ms / 60000); const s = Math.floor((ms % 60000) / 1000);
  return m + ':' + String(s).padStart(2, '0');
}
function fmtTimer(sec) {
  const m = Math.floor(sec / 60); const s = sec % 60;
  return m + ':' + String(s).padStart(2, '0');
}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
let toastTimer;
function showToast(msg) {
  $('toast').textContent = msg;
  $('toast').classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => $('toast').classList.remove('show'), 2000);
}

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
let modalResolve;
function openModal(title, text, confirmLabel) {
  $('modalTitle').textContent = title;
  $('modalText').textContent = text;
  $('modalConfirm').textContent = confirmLabel || 'Confirm';
  $('modalOverlay').classList.add('open');
  return new Promise(resolve => {
    modalResolve = resolve;
    $('modalConfirm').onclick = () => { closeModal(); resolve(true); };
    $('modalCancel').onclick = () => { closeModal(); resolve(false); };
  });
}
function closeModal() { $('modalOverlay').classList.remove('open'); }

/* ‚îÄ‚îÄ View Management ‚îÄ‚îÄ */
let currentView = 'workoutListView';
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  $(id).classList.add('active');
  currentView = id;
  window.scrollTo(0, 0);
}

/* ‚îÄ‚îÄ IndexedDB ‚îÄ‚îÄ */
const DB_NAME = 'vibe.workout-tracker.v1';
const DB_VERSION = 1;
let dbInstance = null;

function openDB() {
  if (dbInstance) return Promise.resolve(dbInstance);
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('sessions')) {
        const s = db.createObjectStore('sessions', { keyPath: 'id' });
        s.createIndex('workoutId', 'workoutId', { unique: false });
        s.createIndex('date', 'date', { unique: false });
      }
      if (!db.objectStoreNames.contains('entries')) {
        const en = db.createObjectStore('entries', { keyPath: 'id' });
        en.createIndex('sessionId', 'sessionId', { unique: false });
        en.createIndex('exerciseId', 'exerciseId', { unique: false });
        en.createIndex('exerciseId_date', ['exerciseId', 'date'], { unique: false });
      }
      if (!db.objectStoreNames.contains('exerciseMeta')) {
        db.createObjectStore('exerciseMeta', { keyPath: 'exerciseId' });
      }
      if (!db.objectStoreNames.contains('preferences')) {
        db.createObjectStore('preferences', { keyPath: 'key' });
      }
    };
    req.onsuccess = (e) => { dbInstance = e.target.result; resolve(dbInstance); };
    req.onerror = (e) => reject(e.target.error);
  });
}

function dbPut(store, value) {
  return openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).put(value);
    tx.oncomplete = () => resolve();
    tx.onerror = (e) => reject(e.target.error);
  }));
}

function dbGet(store, key) {
  return openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = (e) => reject(e.target.error);
  }));
}

function dbGetAll(store, indexName, query) {
  return openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readonly');
    const src = indexName ? tx.objectStore(store).index(indexName) : tx.objectStore(store);
    const req = query !== undefined ? src.getAll(query) : src.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = (e) => reject(e.target.error);
  }));
}

function dbDelete(store, key) {
  return openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).delete(key);
    tx.oncomplete = () => resolve();
    tx.onerror = (e) => reject(e.target.error);
  }));
}

function dbClearStore(store) {
  return openDB().then(db => new Promise((resolve, reject) => {
    const tx = db.transaction(store, 'readwrite');
    tx.objectStore(store).clear();
    tx.oncomplete = () => resolve();
    tx.onerror = (e) => reject(e.target.error);
  }));
}


/* ‚îÄ‚îÄ App State ‚îÄ‚îÄ */
let currentSession = null;  // { id, workoutId, date, status, exerciseIndex, startedAt, completedAt }
let currentWorkout = null;  // reference to WORKOUTS entry
let currentEntries = {};    // exerciseIndex -> entry data
let timerInterval = null;
let timerStartedAt = null;
let timerDurationSec = 0;

/* ‚îÄ‚îÄ Workout List View ‚îÄ‚îÄ */
async function loadWorkoutList() {
  const grid = $('workoutGrid');
  grid.innerHTML = '';

  // Check for in-progress session
  const sessions = await dbGetAll('sessions');
  const inProgress = sessions.find(s => s.status === 'in_progress');
  if (inProgress) {
    const wo = WORKOUTS.find(w => w.id === inProgress.workoutId);
    $('resumeTitle').textContent = 'Resume: ' + (wo ? wo.name : inProgress.workoutId);
    $('resumeDetail').textContent = 'Exercise ' + (inProgress.exerciseIndex + 1) + ' of ' + (wo ? wo.exerciseIds.length : '?');
    $('resumeBanner').style.display = '';
    $('resumeBanner')._sessionId = inProgress.id;
  } else {
    $('resumeBanner').style.display = 'none';
  }

  // Get last completed date per workout
  const completedSessions = sessions.filter(s => s.status === 'complete');
  const lastDates = {};
  for (const s of completedSessions) {
    if (!lastDates[s.workoutId] || s.date > lastDates[s.workoutId]) {
      lastDates[s.workoutId] = s.date;
    }
  }

  for (const wo of WORKOUTS) {
    const card = document.createElement('div');
    card.className = 'workout-card';
    card.onclick = () => startNewSession(wo.id);
    const catClass = wo.category;
    const lastDate = lastDates[wo.id] ? fmtDate(lastDates[wo.id]) : null;
    card.innerHTML =
      '<div class="wc-icon ' + catClass + '">' + wo.icon + '</div>' +
      '<div class="wc-info">' +
        '<div class="wc-name">' + wo.name + '</div>' +
        '<div class="wc-meta">' +
          '<span>' + wo.exerciseIds.length + ' exercises</span>' +
          (lastDate ? '<span>Last: ' + lastDate + '</span>' : '') +
        '</div>' +
      '</div>' +
      '<div class="wc-arrow">&#8250;</div>';
    grid.appendChild(card);
  }
}

/* ‚îÄ‚îÄ Session Management ‚îÄ‚îÄ */
async function startNewSession(workoutId) {
  // Check for existing in-progress session
  const sessions = await dbGetAll('sessions');
  const existing = sessions.find(s => s.status === 'in_progress');
  if (existing && existing.workoutId !== workoutId) {
    const ok = await openModal('Start New Workout?', 'You have an in-progress ' + (WORKOUTS.find(w=>w.id===existing.workoutId)||{}).name + ' session. Starting a new workout will discard it.', 'Start New');
    if (!ok) return;
    await dbDelete('sessions', existing.id);
    const oldEntries = await dbGetAll('entries', 'sessionId', existing.id);
    for (const e of oldEntries) await dbDelete('entries', e.id);
  }

  currentWorkout = WORKOUTS.find(w => w.id === workoutId);
  currentSession = {
    id: uuid(),
    workoutId: workoutId,
    date: new Date().toISOString(),
    status: 'in_progress',
    exerciseIndex: 0,
    startedAt: new Date().toISOString(),
    completedAt: null
  };
  currentEntries = {};
  await dbPut('sessions', currentSession);
  showView('sessionView');
  await renderExercise();
}

async function resumeSession() {
  const sessionId = $('resumeBanner')._sessionId;
  const session = await dbGet('sessions', sessionId);
  if (!session) { showToast('Session not found'); return; }
  currentSession = session;
  currentWorkout = WORKOUTS.find(w => w.id === session.workoutId);
  // Load existing entries
  currentEntries = {};
  const entries = await dbGetAll('entries', 'sessionId', sessionId);
  for (const e of entries) {
    currentEntries[e.exerciseIndex] = e;
  }
  showView('sessionView');
  await renderExercise();
}

async function discardSession() {
  const sessionId = $('resumeBanner')._sessionId;
  const ok = await openModal('Discard Session?', 'This will permanently delete the in-progress session.', 'Discard');
  if (!ok) return;
  const entries = await dbGetAll('entries', 'sessionId', sessionId);
  for (const e of entries) await dbDelete('entries', e.id);
  await dbDelete('sessions', sessionId);
  $('resumeBanner').style.display = 'none';
  showToast('Session discarded');
}

async function confirmExit() {
  const ok = await openModal('Leave Workout?', 'Your progress is saved. You can resume later.', 'Leave');
  if (!ok) return;
  await saveCurrentEntry();
  stopTimer();
  showView('workoutListView');
  await loadWorkoutList();
}

async function finishWorkout() {
  await saveCurrentEntry();
  stopTimer();
  currentSession.status = 'complete';
  currentSession.completedAt = new Date().toISOString();
  await dbPut('sessions', currentSession);
  await renderSummary();
  showView('summaryView');
}

/* ‚îÄ‚îÄ Exercise Stepper ‚îÄ‚îÄ */
async function renderExercise() {
  const idx = currentSession.exerciseIndex;
  const exIds = currentWorkout.exerciseIds;
  const exId = exIds[idx];
  const exercise = EXERCISES[exId];

  // Header
  $('sessionTitle').textContent = currentWorkout.name;
  $('progressFill').style.width = ((idx + 1) / exIds.length * 100) + '%';
  $('progressText').textContent = (idx + 1) + ' / ' + exIds.length;

  // Prev/next previews
  if (idx > 0) {
    $('prevPreview').style.display = '';
    $('prevName').textContent = String(idx).padStart(2, '0') + ' - ' + EXERCISES[exIds[idx - 1]].name;
  } else {
    $('prevPreview').style.display = 'none';
  }
  if (idx < exIds.length - 1) {
    $('nextPreview').style.display = '';
    $('nextName').textContent = String(idx + 2).padStart(2, '0') + ' - ' + EXERCISES[exIds[idx + 1]].name;
  } else {
    $('nextPreview').style.display = 'none';
  }

  // Exercise card
  $('ecNumber').textContent = String(idx + 1).padStart(2, '0');
  $('ecName').textContent = exercise.name;

  // Description (check for user override)
  const meta = await dbGet('exerciseMeta', exId);
  const desc = (meta && meta.userDescription) ? meta.userDescription : (exercise.defaultDescription || '');
  $('ecDesc').textContent = desc;
  $('ecDescTextarea').style.display = 'none';
  $('ecDescEditBtn').textContent = 'edit description';
  $('ecDescTextarea').value = desc;

  // Timer
  stopTimer();
  if (exercise.durationSec) {
    $('ecTimer').style.display = '';
    timerDurationSec = exercise.durationSec;
    timerStartedAt = Date.now();
    $('ecTimer').classList.remove('expired');
    $('ecTimer').textContent = fmtTimer(timerDurationSec);
    timerInterval = setInterval(tickTimer, 250);
  } else {
    $('ecTimer').style.display = 'none';
  }

  // Last time panel
  await renderLastTime(exId);

  // Input fields
  renderInputs(exercise, idx);

  // Nav buttons
  $('btnPrev').disabled = (idx === 0);
  $('btnNext').textContent = (idx === exIds.length - 1) ? 'Finish ‚úì' : 'Next ‚ñ∂';

  // Save exercise position
  currentSession.exerciseIndex = idx;
  await dbPut('sessions', currentSession);
}

function tickTimer() {
  if (!timerStartedAt) return;
  const elapsed = Math.floor((Date.now() - timerStartedAt) / 1000);
  const remaining = Math.max(0, timerDurationSec - elapsed);
  $('ecTimer').textContent = fmtTimer(remaining);
  if (remaining <= 0) {
    $('ecTimer').classList.add('expired');
    stopTimer();
  }
}

function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  timerStartedAt = null;
}

async function renderLastTime(exerciseId) {
  const allEntries = await dbGetAll('entries', 'exerciseId', exerciseId);
  // Filter out entries from current session
  const pastEntries = allEntries
    .filter(e => e.sessionId !== currentSession.id)
    .sort((a, b) => new Date(b.date) - new Date(a.date));

  if (pastEntries.length === 0) {
    $('lastTimePanel').style.display = 'none';
    return;
  }

  $('lastTimePanel').style.display = '';
  const last = pastEntries[0];
  $('ltValue').textContent = fmtDate(last.date) + ': ' + formatEntryValues(last);

  // History
  const historyList = $('historyList');
  historyList.classList.remove('open');
  $('historyToggle').textContent = 'Show all history (' + pastEntries.length + ')';
  historyList.innerHTML = '';
  for (const e of pastEntries) {
    const div = document.createElement('div');
    div.className = 'history-item';
    div.innerHTML = '<span class="hi-date">' + fmtDate(e.date) + '</span> ' + formatEntryValues(e);
    historyList.appendChild(div);
  }
}

function formatEntryValues(entry) {
  const parts = [];
  if (entry.repsLeft != null && entry.repsRight != null) {
    parts.push('R:' + entry.repsRight + ' L:' + entry.repsLeft);
  } else if (entry.reps != null && entry.reps !== '') {
    parts.push(entry.reps + ' reps');
  }
  if (entry.weight != null && entry.weight !== '' && Number(entry.weight) > 0) {
    parts.push(entry.weight + ' lbs' + (entry.isPerDumbbell ? ' /ea' : ''));
  }
  if (entry.partialReps != null && entry.partialReps !== '' && Number(entry.partialReps) > 0) {
    parts.push(entry.partialReps + ' partial');
  }
  if (entry.duration != null && entry.duration !== '') {
    parts.push(fmtTimer(Number(entry.duration)));
  }
  return parts.join(', ') || 'no data';
}

function toggleHistory() {
  const list = $('historyList');
  const open = list.classList.toggle('open');
  $('historyToggle').textContent = open ? 'Hide history' : $('historyToggle').textContent.replace('Hide', 'Show all');
}

/* ‚îÄ‚îÄ Input Rendering ‚îÄ‚îÄ */
function renderInputs(exercise, idx) {
  const section = $('inputSection');
  const existing = currentEntries[idx];
  let html = '<div class="is-label">Record</div>';

  if (exercise.type === ExType.REPS_WEIGHT) {
    html += '<div class="input-row">' +
      '<div class="input-group"><label>Reps</label><input type="number" inputmode="numeric" id="inpReps" value="' + (existing && existing.reps != null ? existing.reps : '') + '"></div>' +
      '<div class="input-group"><label>Weight</label><input type="number" inputmode="numeric" id="inpWeight" value="' + (existing && existing.weight != null ? existing.weight : '') + '"><span class="unit">lbs</span></div>' +
      '</div>' +
      '<div class="input-row">' +
      '<div class="input-group"><label>Partial</label><input type="number" inputmode="numeric" id="inpPartial" value="' + (existing && existing.partialReps != null ? existing.partialReps : '') + '"></div>' +
      '<div class="checkbox-group"><input type="checkbox" id="inpPerDB" ' + (existing && existing.isPerDumbbell ? 'checked' : '') + '><label for="inpPerDB">Per dumbbell</label></div>' +
      '</div>';
  } else if (exercise.type === ExType.REPS_ONLY) {
    html += '<div class="input-row">' +
      '<div class="input-group"><label>Reps</label><input type="number" inputmode="numeric" id="inpReps" value="' + (existing && existing.reps != null ? existing.reps : '') + '"></div>' +
      '<div class="input-group"><label>Partial</label><input type="number" inputmode="numeric" id="inpPartial" value="' + (existing && existing.partialReps != null ? existing.partialReps : '') + '"></div>' +
      '</div>';
  } else if (exercise.type === ExType.LEFT_RIGHT) {
    html += '<div class="input-row">' +
      '<div class="input-group"><label>Right</label><input type="number" inputmode="numeric" id="inpRepsR" value="' + (existing && existing.repsRight != null ? existing.repsRight : '') + '"></div>' +
      '<div class="input-group"><label>Left</label><input type="number" inputmode="numeric" id="inpRepsL" value="' + (existing && existing.repsLeft != null ? existing.repsLeft : '') + '"></div>' +
      '</div>' +
      '<div class="input-row">' +
      '<div class="input-group"><label>Weight</label><input type="number" inputmode="numeric" id="inpWeight" value="' + (existing && existing.weight != null ? existing.weight : '') + '"><span class="unit">lbs</span></div>' +
      '<div class="checkbox-group"><input type="checkbox" id="inpPerDB" ' + (existing && existing.isPerDumbbell ? 'checked' : '') + '><label for="inpPerDB">Per dumbbell</label></div>' +
      '</div>';
  } else if (exercise.type === ExType.DURATION) {
    html += '<div class="input-row">' +
      '<div class="input-group"><label>Duration (sec)</label><input type="number" inputmode="numeric" id="inpDuration" value="' + (existing && existing.duration != null ? existing.duration : '') + '"></div>' +
      '</div>';
  }

  section.innerHTML = html;

  // Pre-fill from last session if no existing entry for this index
  if (!existing) prefillFromLast(exercise, idx);
}

async function prefillFromLast(exercise, idx) {
  const exId = currentWorkout.exerciseIds[idx];
  const allEntries = await dbGetAll('entries', 'exerciseId', exId);
  const past = allEntries
    .filter(e => e.sessionId !== currentSession.id)
    .sort((a, b) => new Date(b.date) - new Date(a.date));
  if (past.length === 0) return;
  const last = past[0];

  if (exercise.type === ExType.REPS_WEIGHT) {
    if (last.reps != null) setVal('inpReps', last.reps);
    if (last.weight != null) setVal('inpWeight', last.weight);
    if (last.partialReps != null) setVal('inpPartial', last.partialReps);
    if (last.isPerDumbbell && $('inpPerDB')) $('inpPerDB').checked = true;
  } else if (exercise.type === ExType.REPS_ONLY) {
    if (last.reps != null) setVal('inpReps', last.reps);
    if (last.partialReps != null) setVal('inpPartial', last.partialReps);
  } else if (exercise.type === ExType.LEFT_RIGHT) {
    if (last.repsRight != null) setVal('inpRepsR', last.repsRight);
    if (last.repsLeft != null) setVal('inpRepsL', last.repsLeft);
    if (last.weight != null) setVal('inpWeight', last.weight);
    if (last.isPerDumbbell && $('inpPerDB')) $('inpPerDB').checked = true;
  } else if (exercise.type === ExType.DURATION) {
    if (last.duration != null) setVal('inpDuration', last.duration);
  }
}

function setVal(id, val) {
  const el = $(id);
  if (el && (val != null && val !== '')) el.value = val;
}

function gatherEntry(idx) {
  const exId = currentWorkout.exerciseIds[idx];
  const exercise = EXERCISES[exId];
  const entry = {
    id: (currentEntries[idx] && currentEntries[idx].id) || uuid(),
    sessionId: currentSession.id,
    exerciseId: exId,
    exerciseIndex: idx,
    date: currentSession.date,
    reps: null, repsLeft: null, repsRight: null,
    weight: null, partialReps: null, duration: null,
    isPerDumbbell: false, notes: ''
  };

  if (exercise.type === ExType.REPS_WEIGHT) {
    entry.reps = numVal('inpReps');
    entry.weight = numVal('inpWeight');
    entry.partialReps = numVal('inpPartial');
    entry.isPerDumbbell = $('inpPerDB') ? $('inpPerDB').checked : false;
  } else if (exercise.type === ExType.REPS_ONLY) {
    entry.reps = numVal('inpReps');
    entry.partialReps = numVal('inpPartial');
  } else if (exercise.type === ExType.LEFT_RIGHT) {
    entry.repsRight = numVal('inpRepsR');
    entry.repsLeft = numVal('inpRepsL');
    entry.weight = numVal('inpWeight');
    entry.isPerDumbbell = $('inpPerDB') ? $('inpPerDB').checked : false;
  } else if (exercise.type === ExType.DURATION) {
    entry.duration = numVal('inpDuration');
  }
  return entry;
}

function numVal(id) {
  const el = $(id);
  if (!el || el.value === '') return null;
  return Number(el.value);
}

async function saveCurrentEntry() {
  if (!currentSession || !currentWorkout) return;
  const idx = currentSession.exerciseIndex;
  const entry = gatherEntry(idx);
  currentEntries[idx] = entry;
  await dbPut('entries', entry);
}

async function stepNext() {
  await saveCurrentEntry();
  const idx = currentSession.exerciseIndex;
  if (idx >= currentWorkout.exerciseIds.length - 1) {
    finishWorkout();
    return;
  }
  currentSession.exerciseIndex = idx + 1;
  stopTimer();
  await renderExercise();
}

async function stepPrev() {
  await saveCurrentEntry();
  if (currentSession.exerciseIndex <= 0) return;
  currentSession.exerciseIndex -= 1;
  stopTimer();
  await renderExercise();
}

/* ‚îÄ‚îÄ Description Editing ‚îÄ‚îÄ */
async function toggleDescEdit() {
  const ta = $('ecDescTextarea');
  const desc = $('ecDesc');
  if (ta.style.display === 'none') {
    ta.style.display = '';
    ta.value = desc.textContent;
    ta.focus();
    $('ecDescEditBtn').textContent = 'save';
  } else {
    const newDesc = ta.value.trim();
    desc.textContent = newDesc;
    ta.style.display = 'none';
    $('ecDescEditBtn').textContent = 'edit description';
    const exId = currentWorkout.exerciseIds[currentSession.exerciseIndex];
    await dbPut('exerciseMeta', { exerciseId: exId, userDescription: newDesc, lastModified: new Date().toISOString() });
    showToast('Description saved');
  }
}

/* ‚îÄ‚îÄ Exercise List Overlay ‚îÄ‚îÄ */
function openExerciseList() {
  const content = $('exerciseListContent');
  content.innerHTML = '';
  const exIds = currentWorkout.exerciseIds;
  for (let i = 0; i < exIds.length; i++) {
    const ex = EXERCISES[exIds[i]];
    const div = document.createElement('div');
    div.className = 'el-item' + (i === currentSession.exerciseIndex ? ' current' : '') + (currentEntries[i] ? ' done' : '');
    div.innerHTML = '<span class="el-num">' + String(i + 1).padStart(2, '0') + '</span><span>' + ex.name + '</span>';
    div.onclick = async (e) => {
      e.stopPropagation();
      await saveCurrentEntry();
      currentSession.exerciseIndex = i;
      stopTimer();
      $('exerciseListOverlay').classList.remove('open');
      await renderExercise();
    };
    content.appendChild(div);
  }
  $('exerciseListOverlay').classList.add('open');
  // Scroll to current
  setTimeout(() => {
    const cur = content.querySelector('.current');
    if (cur) cur.scrollIntoView({ block: 'center' });
  }, 50);
}

function closeExerciseList(e) {
  if (e && e.target !== $('exerciseListOverlay')) return;
  $('exerciseListOverlay').classList.remove('open');
}

/* ‚îÄ‚îÄ Summary ‚îÄ‚îÄ */
async function renderSummary() {
  const list = $('summaryList');
  list.innerHTML = '';
  const exIds = currentWorkout.exerciseIds;
  const entries = await dbGetAll('entries', 'sessionId', currentSession.id);
  const entryMap = {};
  for (const e of entries) entryMap[e.exerciseIndex] = e;

  for (let i = 0; i < exIds.length; i++) {
    const ex = EXERCISES[exIds[i]];
    const entry = entryMap[i];
    const card = document.createElement('div');
    card.className = 'summary-card';
    card.innerHTML = '<div class="sc-name">' + String(i + 1).padStart(2, '0') + '. ' + ex.name + '</div>' +
      '<div class="sc-values">' + (entry ? formatEntryValues(entry) : 'skipped') + '</div>';
    list.appendChild(card);
  }

  // Duration
  if (currentSession.startedAt && currentSession.completedAt) {
    const ms = new Date(currentSession.completedAt) - new Date(currentSession.startedAt);
    $('summaryDuration').textContent = fmtDuration(ms);
  } else {
    $('summaryDuration').textContent = '';
  }
}

/* ‚îÄ‚îÄ Export / Import ‚îÄ‚îÄ */
async function doExport() {
  const sessions = await dbGetAll('sessions');
  const entries = await dbGetAll('entries');
  const exerciseMeta = await dbGetAll('exerciseMeta');
  const payload = {
    version: 1,
    app: 'workout-tracker',
    exportedAt: new Date().toISOString(),
    data: { sessions, entries, exerciseMeta }
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'workout-tracker-export-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Exported');
}

async function doImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const payload = JSON.parse(text);
    if (!payload.data) throw new Error('Invalid format');
    const d = payload.data;
    if (d.sessions) for (const s of d.sessions) await dbPut('sessions', s);
    if (d.entries) for (const e of d.entries) await dbPut('entries', e);
    if (d.exerciseMeta) for (const m of d.exerciseMeta) await dbPut('exerciseMeta', m);
    showToast('Imported ' + (d.sessions ? d.sessions.length : 0) + ' sessions');
    await loadWorkoutList();
  } catch (err) {
    showToast('Import failed: ' + err.message);
  }
  event.target.value = '';
}

async function confirmClear() {
  const ok = await openModal('Clear All Data?', 'This will permanently delete all workout sessions and history. This cannot be undone.', 'Clear');
  if (!ok) return;
  await dbClearStore('sessions');
  await dbClearStore('entries');
  await dbClearStore('exerciseMeta');
  showToast('All data cleared');
  await loadWorkoutList();
}

/* ‚îÄ‚îÄ Keyboard Navigation ‚îÄ‚îÄ */
document.addEventListener('keydown', function(e) {
  if (currentView !== 'sessionView') return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.key === 'ArrowLeft') stepPrev();
  else if (e.key === 'ArrowRight') stepNext();
});

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
openDB().then(() => loadWorkoutList()).catch(err => console.error('DB init failed:', err));

/* ‚îÄ‚îÄ APP STATE PLACEHOLDER ‚îÄ‚îÄ */
/* Session logic, stepper, rendering will be inserted here */
</script>
</body>
</html>
